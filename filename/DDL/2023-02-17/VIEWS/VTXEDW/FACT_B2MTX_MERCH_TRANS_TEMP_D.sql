CREATE OR REPLACE VIEW P1VTXEDW.FACT_B2MTX_MERCH_TRANS_TEMP_D (
  AS_OF_DT,
  EVENT_ID,
  EVENT_START_DT,
  PRODUCT,
  CHANNEL,
  EQUIPMENT,
  TRANS_FUNCTION,
  CARD_ACCEPTANCE,
  EVENT_GROUP_ID,
  TRAN_REAS_CODE_BCOMC,
  BATCH_NUMBER_PCOEC,
  TRANSACTION_CODE_PCOEC,
  TRANSACTION_AMOUNT)
AS SELECT 
TO_DATE(BD.BUSINESSDATE ,'yyyy-MM-dd') AS  AS_OF_DT,
CAST(EVENT_J01.Event_Id AS BIGINT) AS EVENT_ID,
TO_DATE(EVENT_J01.Event_START_dT ,'yyyy-MM-dd') AS EVENT_START_DT,
CAST(Case 
      WHEN EVENT_GROUP_ASSOC_J01.Event_Group_Id IN (220, 222) Then 'Deejung'
      Else 'Merchant' 
    END AS VARCHAR (100)) AS PRODUCT,
CAST(Case
      When EVENT_GROUP_ASSOC_J01.Event_Group_Id = 220  
    Then 'Mail'
      WHEN (EVENT_GROUP_ASSOC_J01.Event_Group_Id = 222 AND CONTACT_EVENT_J01.Channel_Type_Cd= 122 ) 
    Then 'Card Present'
      WHEN (EVENT_GROUP_ASSOC_J01.Event_Group_Id = 222 AND CONTACT_EVENT_J01.Channel_Type_Cd= 185 )
    Then 'eCOM'
      WHEN EVENT_GROUP_ASSOC_J01.Event_Group_Id = 221
    Then 'Card Present'
      WHEN (EVENT_GROUP_ASSOC_J01.Event_Group_Id IN (223, 224) AND CONTACT_EVENT_J01.Channel_Type_Cd= 185 )
    Then 'E-Commerce'
      WHEN (EVENT_GROUP_ASSOC_J01.Event_Group_Id IN (225, 226) AND CONTACT_EVENT_J01.Channel_Type_Cd= 184 )
    Then 'Card Present'
      WHEN (EVENT_GROUP_ASSOC_J01.Event_Group_Id IN (225, 226) AND PARTY_PARTY_CLASS_ASSOC_J01.PARTY_CLASS_VALUE_CD IN (3,4))
    Then 'Mail/Phone'
      WHEN (EVENT_GROUP_ASSOC_J01.Event_Group_Id IN (225, 226) AND PARTY_PARTY_CLASS_ASSOC_J01.PARTY_CLASS_VALUE_CD = 5)
    Then 'Recurring'
       ELSE 'Card Present' 
   END AS VARCHAR(100)) AS CHANNEL,
REF_CS006150.SHORT_DESCRIPTION AS EQUIPMENT,
REF_CS012950.SHORT_DESCRIPTION AS TRANS_FUNCTION,
CAST(CASE 
      WHEN EVENT_GROUP_ASSOC_J01.Event_Group_Id = 220 THEN 'Manual'
      WHEN EVENT_GROUP_ASSOC_J01.Event_Group_Id = 221 THEN 'Swipe'
      WHEN (EVENT_GROUP_ASSOC_J01.Event_Group_Id = 222 AND EVENT_J01. Event_Activity_Type_Cd = 10077) THEN 'Manual'
      WHEN EVENT_GROUP_ASSOC_J01.Event_Group_Id IN (223,224) THEN 'Key-in'
      ELSE REF_CS044477.Short_Description 
    END
 AS VARCHAR(100)) AS CARD_ACCEPTANCE,
REF_CS042050.SHORT_DESCRIPTION AS EVENT_GROUP_ID,
CAST(CASE WHEN EVENT_GROUP_ASSOC_J01.Event_Group_Id = 220 THEN SUBSTR(REF_CS042850.Short_Description,4,2) ELSE NULL
      END AS VARCHAR(100)) AS TRAN_REAS_CODE_BCOMC,
CAST( CASE WHEN EVENT_GROUP_ASSOC_J01.Event_Group_Id = 221 THEN SUBSTR(EVENT_J01.Transaction_ID,11,5) ELSE NULL
    END AS VARCHAR(100)) AS BATCH_NUMBER_PCOEC,
CAST(CASE WHEN EVENT_GROUP_ASSOC_J01.Event_Group_Id = 221 THEN SUBSTR(REF_CS042850.Short_Description,1,2) ELSE NULL
    END AS VARCHAR(10)) AS TRANSACTION_CODE_PCOEC,
CAST( CASE WHEN EVENT_GROUP_ASSOC_J01.Event_Group_Id = 220 THEN FINANCIAL_EVENT_J02.Event_Amt
WHEN (EVENT_GROUP_ASSOC_J01.Event_Group_Id = 221 AND SUBSTR(REF_CS042850.Short_Description,1,2) IN ('06','25','27') ) /* edit */
THEN FINANCIAL_EVENT_J02.Event_Local_Amt* -1
ELSE FINANCIAL_EVENT_J02.Event_Local_Amt
END AS DECIMAL(18,2)) AS TRANSACTION_AMOUNT

 FROM P1VTTEDW.EVENT AS EVENT_J01

LEFT JOIN P1VTTEDW.EVENT_GROUP_ASSOC AS EVENT_GROUP_ASSOC_J01
ON EVENT_GROUP_ASSOC_J01.EVENT_ID=EVENT_J01.EVENT_ID
AND EVENT_GROUP_ASSOC_J01.EVENT_START_DT=EVENT_J01.EVENT_START_DT
AND EVENT_J01.CTL_ID = '101' --[B2MTX]
INNER JOIN P1VTPEDW.TVB2MTX_BUSINESSDATE_D AS BD
ON EVENT_GROUP_ASSOC_J01.START_DT=BD.BUSINESSDATE
AND EVENT_GROUP_ASSOC_J01.CTL_ID = '101' --[B2MTX]
AND EVENT_GROUP_ASSOC_J01.EVENT_GROUP_ID IN (220,221,222,223,224,225,226)
AND EVENT_J01.START_DT=BD.BUSINESSDATE

LEFT JOIN P1VUTEDW.REFERENCE_DESCRIPTION AS REF_CS042050
ON REF_CS042050.EDW_CODE=EVENT_GROUP_ASSOC_J01.EVENT_GROUP_ID
AND REF_CS042050.CODE_SET_ID = 'CS042050'
AND REF_CS042050.LANGUAGE_ID = 1

LEFT JOIN P1VUTEDW.REFERENCE_DESCRIPTION AS REF_CS042850
ON EVENT_J01.EVENT_PURPOSE_TYPE_CD = REF_CS042850.EDW_CODE 
AND  REF_CS042850.CODE_SET_ID = 'CS042850'
AND REF_CS042850.LANGUAGE_ID = 1 

LEFT JOIN P1VTTEDW.CONTACT_EVENT AS CONTACT_EVENT_J01
ON CONTACT_EVENT_J01.EVENT_ID=EVENT_J01.EVENT_ID
AND CONTACT_EVENT_J01.EVENT_START_DT=EVENT_J01.EVENT_START_DT
AND  CONTACT_EVENT_J01.START_DT=BD.BUSINESSDATE
AND CONTACT_EVENT_J01.CTL_ID = '101' --[B2MTX]

LEFT JOIN P1VUTEDW.REFERENCE_DESCRIPTION AS REF_CS006150
ON REF_CS006150.EDW_CODE=CONTACT_EVENT_J01.CHANNEL_TYPE_CD
AND REF_CS006150.CODE_SET_ID = 'CS006150'
AND REF_CS006150.CODE_ID = 43
AND REF_CS006150.LANGUAGE_ID = 1

LEFT JOIN P1VUTEDW.REFERENCE_DESCRIPTION AS REF_CS044477
ON REF_CS044477.EDW_CODE=CONTACT_EVENT_J01.ACCESS_MEDIUM_TYPE_CD
AND REF_CS044477.CODE_SET_ID = 'CS044477'
AND REF_CS044477.CODE_ID = 740
AND REF_CS044477.LANGUAGE_ID = 1

LEFT JOIN P1VTTEDW.CARD_EVENT AS CARD_EVENT_J01
ON CARD_EVENT_J01.EVENT_ID=EVENT_J01.EVENT_ID
AND CARD_EVENT_J01.EVENT_START_DT=EVENT_J01.EVENT_START_DT
AND  CARD_EVENT_J01.START_DT=BD.BUSINESSDATE
AND CARD_EVENT_J01.CTL_ID = '101' --[B2MTX]

LEFT JOIN P1VTTEDW.EVENT_PARTY AS EVE_PARTY_J01
ON EVE_PARTY_J01.EVENT_ID=EVENT_J01.EVENT_ID
AND EVE_PARTY_J01.EVENT_START_DT=EVENT_J01.EVENT_START_DT
AND  EVE_PARTY_J01.START_DT=BD.BUSINESSDATE
AND EVE_PARTY_J01.PARTY_ROLE_CD = 3
AND EVE_PARTY_J01.CTL_ID = '101' --[B2MTX]

LEFT JOIN P1VTTEDW.PARTY_PARTY_CLASS_ASSOC AS PARTY_PARTY_CLASS_ASSOC_J01
ON PARTY_PARTY_CLASS_ASSOC_J01.PARTY_ID=EVE_PARTY_J01.PARTY_ID
AND PARTY_PARTY_CLASS_ASSOC_J01.CTL_ID = '005' --[B2MTX]
AND PARTY_PARTY_CLASS_ASSOC_J01.PARTY_CLASSIFICATION_CD = '7'  --[CS023450: MERCHANT OF SCB]
AND BD.BUSINESSDATE  BETWEEN PARTY_PARTY_CLASS_ASSOC_J01.START_DT AND PARTY_PARTY_CLASS_ASSOC_J01.END_DT
AND PARTY_PARTY_CLASS_ASSOC_J01.RECORD_DELETED_FLAG=0

LEFT JOIN P1VTTEDW.FINANCIAL_EVENT as FINANCIAL_EVENT_J02
ON FINANCIAL_EVENT_J02.EVENT_ID=EVENT_J01.EVENT_ID
AND FINANCIAL_EVENT_J02.EVENT_START_DT=EVENT_J01.EVENT_START_DT
AND  FINANCIAL_EVENT_J02.START_DT=BD.BUSINESSDATE
AND FINANCIAL_EVENT_J02.CTL_ID = '101' --[B2MTX]

LEFT JOIN P1VUTEDW.REFERENCE_DESCRIPTION as REF_CS012950
ON REF_CS012950.EDW_CODE=EVENT_J01.EVENT_ACTIVITY_TYPE_CD
AND REF_CS012950.Code_Set_Id = 'CS012950'
AND REF_CS012950.Language_Id = 1

LEFT JOIN P1VUTEDW.REFERENCE_DESCRIPTION as REF_CS013400
ON REF_CS013400.EDW_CODE=EVENT_J01.EVENT_STATUS_CD
AND REF_CS013400.Code_Set_Id = 'CS013400'
AND REF_CS013400.Code_Id = 85
AND REF_CS013400.Language_Id = 1
WHERE EVENT_J01. EVENT_ACTIVITY_TYPE_CD NOT  IN ('10078','10082')
AND EVENT_J01.CTL_ID ='101'
