CREATE OR REPLACE VIEW P1VSGMF.ATS_REPORT_FILE_1_0 (
  EDW_RECORD_NO,
  RP_IDENT,
  RP_BRANCH,
  RP_ACCT,
  RP_DATE,
  RP_TIME,
  RP_ACCTYPE,
  RP_SUBTYPE,
  RP_DEPTERM,
  RP_CUSTYPE,
  RP_BTYPE,
  RP_STATUS,
  RP_TRCODE,
  RP_NUMBER,
  RP_AMT,
  RP_ORIGINAMT,
  RP_BKDATE,
  RP_DLT,
  RP_HOLDCODE,
  RP_REASON,
  RP_BANKCODE,
  RP_TRANCODE,
  RP_TERMNO,
  RP_TELLERNO,
  RP_TRANNUM,
  RP_COMPCODE,
  RP_TRANSTATUS,
  RP_CKDIGIT,
  RP_OLDBAL,
  RP_NEWBAL,
  RP_ODLIMIT,
  RP_AMTHOLD,
  RP_ENC,
  RP_UPDSTATUS,
  RP_NAME,
  RP_DEBITCOND,
  RP_MINBALANCE,
  RP_CHARGEAMT,
  REFERENCE,
  START_DT,
  END_DT,
  RECORD_DELETED_FLAG,
  CTL_ID,
  INS_PROC_NAME,
  INS_TXF_BATCHID,
  UPD_PROC_NAME,
  UPD_TXF_BATCHID,
  TMP_RP_BKDATE,
  TRANSACTION_DATE)
AS select 
STGMERGE.EDW_RECORD_NO,
STGMERGE.RP_IDENT,
STGMERGE.RP_BRANCH,
STGMERGE.RP_ACCT,
COALESCE(CC.DEFAULT_DATE, to_date('1000-01-02','yyyy-MM-dd')) AS RP_DATE /*D1*/,
STGMERGE.RP_TIME,
STGMERGE.RP_ACCTYPE,
STGMERGE.RP_SUBTYPE,
STGMERGE.RP_DEPTERM,
STGMERGE.RP_CUSTYPE,
STGMERGE.RP_BTYPE,
STGMERGE.RP_STATUS,
STGMERGE.RP_TRCODE,
STGMERGE.RP_NUMBER,
STGMERGE.RP_AMT,
STGMERGE.RP_ORIGINAMT,
STGMERGE.D2 as RP_BKDATE,
STGMERGE.RP_DLT,
STGMERGE.RP_HOLDCODE,
STGMERGE.RP_REASON,
STGMERGE.RP_BANKCODE,
STGMERGE.RP_TRANCODE,
STGMERGE.RP_TERMNO,
STGMERGE.RP_TELLERNO,
STGMERGE.RP_TRANNUM,
STGMERGE.RP_COMPCODE,
STGMERGE.RP_TRANSTATUS,
STGMERGE.RP_CKDIGIT,
STGMERGE.RP_OLDBAL,
STGMERGE.RP_NEWBAL,
STGMERGE.RP_ODLIMIT,
STGMERGE.RP_AMTHOLD,
STGMERGE.RP_ENC,
STGMERGE.RP_UPDSTATUS,
STGMERGE.RP_NAME,
STGMERGE.RP_DEBITCOND,
STGMERGE.RP_MINBALANCE,
STGMERGE.RP_CHARGEAMT,
STGMERGE.REFERENCE,
STGMERGE.START_DT,
STGMERGE.END_DT,
STGMERGE.RECORD_DELETED_FLAG,
STGMERGE.CTL_ID,
STGMERGE.INS_PROC_NAME,
STGMERGE.INS_TXF_BATCHID,
STGMERGE.UPD_PROC_NAME,
STGMERGE.UPD_TXF_BATCHID,
STGMERGE.TMP_DT as TMP_RP_BKDATE,
COALESCE(DEFAULT_DATE,to_date('1000-01-02', 'yyyy-MM-dd')) as TRANSACTION_DATE
FROM  p1dutedw.CHAR_CALENDAR CC
RIGHT OUTER JOIN
(
SELECT	EDW_RECORD_NO,
  RP_IDENT,
  RP_BRANCH,
  RP_ACCT,
  RP_DATE,
  RP_TIME,
  RP_ACCTYPE,
  RP_SUBTYPE,
  RP_DEPTERM,
  RP_CUSTYPE,
  RP_BTYPE,
  RP_STATUS,
  RP_TRCODE,
  RP_NUMBER,
  RP_AMT,
  RP_ORIGINAMT,
  COALESCE(C2.DEFAULT_DATE, to_date('1000-01-02','yyyy-MM-dd')) AS D2,
  COALESCE(C3.DEFAULT_DATE, to_date('1000-01-02','yyyy-MM-dd')) AS RP_DLT,
  RP_HOLDCODE,
  RP_REASON,
  RP_BANKCODE,
  RP_TRANCODE,
  RP_TERMNO,
  RP_TELLERNO,
  RP_TRANNUM,
  RP_COMPCODE,
  RP_TRANSTATUS,
  RP_CKDIGIT,
  RP_OLDBAL,
  RP_NEWBAL,
  RP_ODLIMIT,
  RP_AMTHOLD,
  RP_ENC,
  RP_UPDSTATUS,
  RP_NAME,
  RP_DEBITCOND,
  RP_MINBALANCE,
  RP_CHARGEAMT,
  REFERENCE,
  COALESCE(C2.DEFAULT_DATE, to_date('1000-01-02','yyyy-MM-dd')) AS TMP_DT,
  START_DT,
  END_DT,
  RECORD_DELETED_FLAG,
  CTL_ID,
  INS_PROC_NAME,
  INS_TXF_BATCHID,
  UPD_PROC_NAME,
  UPD_TXF_BATCHID
FROM p1dsgedw.ATS_REPORT_FILE_1_0_T1 AS T1

LEFT OUTER JOIN p1dutedw.CHAR_CALENDAR AS C2
ON COALESCE(T1.RP_BKDATE,'NA') = C2.CDT_DDMMYY

LEFT OUTER JOIN p1dutedw.CHAR_CALENDAR AS C3
ON COALESCE(T1.RP_DLT,'NA') = C3.CDT_DDMMYY


) STGMERGE

ON COALESCE(STGMERGE.RP_DATE,'NA') = CC.CDT_DDMMYY
